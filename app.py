from flask import Flask,redirect,url_for,render_template,request
from result import get_result_from_id
from mysqldatabase import get_last_id,add_data_into_database,get_data_from_hash
from upload_data import upload_file_to_cuckoo
from Hash import SHA256
import os
from check_yara import detect_malware
from report import file_analyst
from export_attribute import get_predict

app = Flask(__name__)

class Sample:
    def __init__(self,id,IP,name,hash_SHA256,Pre):
        self.id = id
        self.IP = IP
        self.name = name
        self.hash_SHA256 = hash_SHA256
        self.Pre = Pre

@app.route('/', methods=["POST", "GET"])
def hello_world():
    if request.method == "POST":
        try:
            id = int(request.form["name"])
        except ValueError :
            id = None
        if id:
            return redirect(url_for("result",result_id = int(id)))
    return render_template('home.html')

@app.route('/result/<int:result_id>', methods=["POST", "GET"])
def result(result_id):
    result = get_result_from_id(result_id)
    if request.method == "POST":
        return redirect(url_for("hello_world"))
    return render_template('index.html',content = result)

@app.route('/upload')
def upload_form():
    return render_template('upload.html')

@app.route('/upload/upload', methods=['POST'])
def upload_file():
    uploaded_file = request.files['file']
    client_ip = request.remote_addr
    if uploaded_file.filename != '':
        data = uploaded_file.getvalue()
        # Kiem tra file da co trong database chua
        # Lay hash_SHA256 cua file
        data_SHA256 = SHA256(data)
        # Tim ban ghi co hash giong data
        record = get_data_from_hash(data_SHA256)
        
        if record:
            return redirect(url_for("result",result_id = record.id))
        else :
            
            #Kiem tra voi Yara Rule
            check_yara = detect_malware(data)
            if check_yara:
                pre = 1
            else :
                # Lấy ID 
                task_id = upload_file_to_cuckoo(data,uploaded_file.filename)
                # Lấy báo cáo và kết quả dự đoán
                report = file_analyst(task_id)
                pre = get_predict(report)
    
            # Tạo 1 mẫu lưu kết quả
            result = Sample(id=get_last_id()+1,IP=client_ip,name=uploaded_file.filename,hash_SHA256=SHA256(data),Pre=pre)
            add_data_into_database(result)
            # Lưu file vào thư mục uploads trong thư mục hiện tại
            file_path = os.path.join('uploads', uploaded_file.filename)
            uploaded_file.save(file_path)
            return redirect(url_for("result",result_id = int(get_last_id())))
    else:
        return 'Không có file được chọn.'

if __name__ == "__main__": 
    if not os.path.exists('uploads'):
        os.makedirs('uploads')
    app.run(debug=True,host='0.0.0.0',port=5000)